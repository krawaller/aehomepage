(function(){CATS.bb.SequenceView=CATS.bb.BaseView.extend({className:"sequence absbox",localizeid:"sequence",events:{"click .backbutton":"back","click .sequencetopbutton":"top","click .resultbutton":"showResult","click .stepbystepbutton":"showStepByStep"},showResult:function(){this.ui.resultbutton.addClass("active");this.ui.stepbystepbutton.removeClass("active");this.ui.firstresultcontainer.removeClass("hidden");return this.ui.substeps.addClass("hidden")},showStepByStep:function(){this.ui.resultbutton.removeClass("active");this.ui.stepbystepbutton.addClass("active");this.ui.firstresultcontainer.addClass("hidden");return this.ui.substeps.removeClass("hidden")},top:function(){return this.trigger("sequencetop")},back:function(){return this.trigger("sequenceback")},passOnZoom:function(view,path){return this.trigger("zoom",view,path)},passOnNewSequenceView:function(view){return this.trigger("newsequenceview",view)},initialize:function(o,path,parenttool,grandparenttool,parentpath,prevstepnums){this.o=o;this.path=path!=null?path:[];this.parenttool=parenttool;this.grandparenttool=grandparenttool;this.parentpath=parentpath;this.prevstepnums=prevstepnums!=null?prevstepnums:[];_.bindAll(this,"showmath");this.descriptor="Sequence-"+this.prevstepnums.join(",")+"-"+this.o.who;return this.constructor.__super__.initialize.apply(this,[o])},masterSpecialStrings:function(){var intro,_ref;this.why=(_ref=this.o.who)==="simplifier"||_ref==="decimalifier"||_ref==="demonstration"?this.o.who:"example";this.setText(this.ui.firstresultheadline,["ui","mastersequence","headline"+this.why,CATS.settings.lang],false,false,true);this.setText(this.ui.substepsheadline,["ui","mastersequence",this.o.because+"headlinesteps",CATS.settings.lang],false,false,true);return intro=this.why+"intro"+(!this.o.steps?"none":this.o.steps.length===1?"single":"multiple")},specialStrings:function(){var lang,path;lang=CATS.settings.lang;path=["ui","sequence",this.prevstepnums.length<2?"backbuttonhead":"backbuttonstep",lang];this.ui.topbackbutton.html(this.getText(path).replace("%s","<span class='inlinerownum'>"+this.prevstepnums.slice(0,-1).join(".")+"</span>"));this.ui.bottombackbutton.html(this.getText(path).replace("%s","<span class='inlinerownum'>"+this.prevstepnums.slice(0,-1).join(".")+"</span>"));this.ui.substepsheadline.setText("substepsheadline");this.ui.firstresultheadline.setText("headlineintro");return this.ui.firstresultheadline.html(this.ui.firstresultheadline.html()+" "+this.prevstepnums.join("."))},render:function(){var lang,n,opview,path,step,_i,_len,_ref,_ref1,_ref2,_ref3,_ref4;lang=CATS.settings.lang;this.$el.html(CATS.cache.templates["#sequenceviewtemplate"]);this.setUI("sequencetopbutton","startcontainer","sequencefooter","summary","bottombackbutton","firstresultcontainer","substeps","substepsheadline","firstresultheadline");this.setUI("siderownum","topbackbutton","topheader","toprownum","toptoolname","resultbutton","stepbystepbutton","whatresbuttons","substepsintro","loadindicator");this.setUI("missionbox","calcmissionbox","opexamplemissionbox");if(false){this.showResult()}else{this.ui.whatresbuttons.hide()}this.views=[];this.ui.firstresultcontainer.setText;path=(_ref=this.o.because)==="toolexample"||_ref==="userinputsingle"||_ref==="userinputsingleatomic"||_ref==="inputexamplesingle"||this.o.because==="simplifying"&&((_ref1=this.grandparenttool)==="simplifier"||_ref1==="decimalifier")?[this.o.who,lang,"explanation"]:[this.grandparenttool,lang,"steps",this.o.because];if(this.o.who!=="demonstration"){this.ui.firstresultcontainer.setText(["tools"].concat(path),false,false,true);if(this.o.steps){this.ui.firstresultcontainer.html(this.ui.firstresultcontainer.html().replace("%NUMSTEPS",CATS.texts.numberStr(this.o.steps.length,lang).capitalize()))}}else{this.ui.firstresultcontainer.setText(["tools","demonstration",lang,"steps",this.o.demonstrationname+"_OPINTRO"],false,false,true)}_ref2=[this.o].concat(this.o.steps||[]);for(n=_i=0,_len=_ref2.length;_i<_len;n=++_i){step=_ref2[n];if(!(n>0)){continue}opview=new CATS.bb.OperationView(step,n,!n?this.parentpath:this.path,!(true||n||!this.prevstepnums.length)?"topbackbutton backbutton":void 0,n?this.parenttool:this.grandparenttool,this.prevstepnums);this.listenTo(opview,"zoom",this.passOnZoom);this.listenTo(opview,"sequenceback",this.back);this.listenTo(opview,"sequencetop",this.top);this.listenTo(opview,"newsequenceview",this.passOnNewSequenceView);this.views.push(opview);this.ui[n?"substeps":"firstresultcontainer"].append(opview.render(n>0).$el.addClass(n?"substep":"firstsubstep"));if(n>0&&((_ref3=this.o.steps)!=null?_ref3.length:void 0)&&n<((_ref4=this.o.steps)!=null?_ref4.length:void 0)){this.ui.substeps.append($("<div class='opbreaker'><div/></div>"))}}if(this.o.steps&&this.o.steps.length){this.ui.startcontainer.html(CATS.app.mathmlprinter(CATS.math.lookUp(this.o.before,this.path),[],[],true,CATS.settings,true))}else{this.ui.substeps.find(".operation,.opbreaker").remove()}this.ui.substepsintro.hide();if(this.prevstepnums.length){this.specialStrings();this.ui.toprownum.text(this.prevstepnums.concat(this.rownum||[]).join("."));this.ui.toptoolname.html(this.toolLink(this.o.who,CATS.settings.lang))}else{this.masterSpecialStrings();if(this.o.because==="toolexample"){this.ui.toptoolname.html(this.toolLink(this.o.who,CATS.settings.lang));this.ui.toprownum.hide()}else{this.ui.topheader.hide()}}if(false){this.ui.siderownum.text(this.prevstepnums.concat(this.rownum||[]).join("."))}else{this.ui.siderownum.hide()}this.descriptor=this.descriptor+"-rendered";this.rendered=true;if(this.prevstepnums.length<2){this.ui.sequencetopbutton.hide()}if(!this.prevstepnums.length){this.ui.bottombackbutton.hide()}this.updateMission();this.listenTo(Backbone,"updatemission",this.updateMission);this.listenTo(Backbone,"updatelesson",this.updateMission);return this},kill:function(){var view,_i,_len,_ref;_ref=this.views||[];for(_i=0,_len=_ref.length;_i<_len;_i++){view=_ref[_i];view.kill()}return this.cleanup()},showmath:function(cb){this.ui.loadindicator.addClass("hidden");this.ui.substeps.removeClass("hidden");if(cb){return cb()}},getready:function(callback){var me;if(!this.rendered){this.render();me=this;return this.typeset(this.$el,function(){me.showmath();return callback()})}else{this.showmath();return callback()}},updateMission:function(){if(this.grandparenttool!=="decimalifier"||"green"===CATS.school.getLessonStatus("decimalintro")||!CATS.math.equal(this.o.before,{type:"product",objs:[{type:"number",val:"3"},{type:"const",val:"pi"}]})){this.ui.missionbox.hide()}else{this.ui.missionbox.show();if(CATS.school.getMissionStatus("decimal")){this.ui.missionbox.addClass("togglesecond")}else{this.ui.missionbox.removeClass("togglesecond")}}if(this.grandparenttool==="decimalifier"||"green"===CATS.school.getLessonStatus("calcintro")||!CATS.math.equal(this.o.before,{type:"sum",objs:[{type:"number",val:"45"},{type:"negation",objs:[{type:"number",val:"3"}]}]})){this.ui.calcmissionbox.hide()}else{this.ui.calcmissionbox.show();if(CATS.school.getMissionStatus("calc")){this.ui.calcmissionbox.addClass("togglesecond")}else{this.ui.calcmissionbox.removeClass("togglesecond")}}if(this.grandparenttool==="decimalifier"||this.o.because!=="toolexample"||this.o.who!=="absorbNegSum"||"green"===CATS.school.getLessonStatus("opexample")){return this.ui.opexamplemissionbox.hide()}else{this.ui.opexamplemissionbox.show();if(CATS.school.getMissionStatus("opexample")){return this.ui.opexamplemissionbox.addClass("togglesecond")}else{return this.ui.opexamplemissionbox.removeClass("togglesecond")}}}})}).call(this);