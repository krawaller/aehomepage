(function(){var examples;examples=typeof require==="undefined"?this.CATS.texts.examples:require("../app/texts_examples");CATS.bb.ParserView=CATS.bb.BaseView.extend({localizeid:"parser",category:"calc",events:{"click .buttoncalculate":"enterMath","focus .textfield":"focusTextField","blur .textfield":"blurTextField","keyup .textfield":"inputKeypress","click .calcbutton":"enterMath","click .textclearerbtn":"clearInput"},className:"viewbox parserview",clearInput:function(e){var me;if(this.ui.textfield.val()){me=this;me.ui.textfield.val("").focus();me.$el.removeClass("notempty");me.analyzeMathEntry("")}this.ui.textfield.focus();e.preventDefault();return false},updateClearBtn:function(){if(this.ui.textfield.val()===""){return this.$el.removeClass("notempty")}else{return this.$el.addClass("notempty")}},analyzeMathEntry:function(txt,force){var me;this.missionpotential=false;this.mission2potential=false;this.ui.missionbox.hide();me=this;if(force){this.analyzeMathEntryDo(txt)}if(txt!==this.before){this.before=txt;clearTimeout(this.timeout);return this.timeout=setTimeout(function(){return me.analyzeMathEntryDo(txt)},200)}},analyzeMathEntryDo:function(txt){var e,err,lang,mathml,me,o;console.log("MATHENTRY",txt);try{o=CATS.app.parseExpression(txt,CATS.settings);mathml=CATS.app.mathmlprinter(o,[],[],true,CATS.settings,true,false,true);lang=CATS.settings.lang;this.ui.math.empty();err=CATS.app.check(o);if(o.type==="void"){this.ui.emptybox.show();this.ui.analysis.hide();if(err&&err[0]==="noparse"){return this.setError(err[0],err[1])}}else{this.ui.math.html(mathml);me=this;this.typeset(this.ui.math,function(){return me.ui.math.append(me.reportLink("interpret",JSON.stringify({input:txt,obj:o})))});this.ui.inputdescription.html(CATS.texts.ui.mathview.enteredbeginning[lang]+" "+CATS.texts.processText(CATS.texts.describe(o,lang),lang)+this.reportLink("describe",JSON.stringify({obj:o})));if(err&&err[0]==="noparse"){this.setError(err[0],err[1])}else{if(this.showingerror){this.showingerror=false;clearTimeout(this.errortimeout);this.ui.errormsg.fadeOut("fast")}}this.ui.emptybox.hide();return this.ui.analysis.show()}}catch(_error){e=_error;this.trigger("explosion",{str:txt,obj:o,error:e});throw e}},focusTextField:function(){var me;this.ui.errormsg.hide();this.ui.introhelptext.hide();Backbone.trigger("focusTextField");this.analyzeMathEntry(this.ui.textfield.val());this.beforetext=this.ui.textfield.val();this.updateClearBtn();me=this;setTimeout(function(){var _base;if(typeof(_base=me.ui.textfield.get(0)).select==="function"){_base.select()}if(CATS.ondevice){return $("body").animate({scrollTop:0},1)}});return CATS.parser=true},blurTextField:function(){var me;me=this;return setTimeout(function(){if(!me.ui.textfield.is(":focus")){return me.blurTextFieldReal()}},250)},blurTextFieldReal:function(){Backbone.trigger("blurTextField");return this.fixIntro()},initialize:function(o){this.instruction=(o!=null?o.instruction:void 0)||"enterexpressiontosimplify";_.bind(this.analyzeMathEntryDo,this);_.bind(this.doMath,this);this.listenTo(Backbone,"updatelesson",this.fixIntro);this.listenTo(Backbone,"inputparsertext",this.remoteInput);this.listenTo(Backbone,"updatelesson",this.updateMission);this.listenTo(Backbone,"updatemission",this.updateMission);this.constructor.__super__.initialize.apply(this,arguments);CATS.history=JSON.parse(localStorage.getItem(this.historyName())||JSON.stringify({}));Backbone.trigger("newcalc");Backbone.trigger("updatedhistory");this.DESCRIPTION="expression";return this.localizeid="parser"},historyName:function(){return"ALGEBRAEXPLORERCALCHIST-"+CATS.settings.lang+"-"+(CATS.settings.currentpupil||"AEDEFAULT")},setHistory:function(str){var datestr,daystr,monthstr,now;now=new Date;monthstr=now.getMonth()+1;daystr=now.getDate();if(monthstr<10){monthstr="0"+monthstr}if(daystr<10){daystr="0"+daystr}datestr=now.getFullYear()+"-"+monthstr+"-"+daystr;if(!CATS.history[datestr]){CATS.history[datestr]={}}delete CATS.history[datestr][str];CATS.history[datestr][str]=true;localStorage.setItem(this.historyName(),JSON.stringify(CATS.history));return Backbone.trigger("updatedhistory")},render:function(){var _ref;this.setContent(CATS.cache.templates["#parsertemplate"]);if(typeof window!=="undefined"&&window!==null){if((_ref=window.FastClick)!=null){_ref.attach(this.$(".textclearerbtn").get(0))}}this.setTitle("parserheadline",!this.noroot);this.setUI("mission2box","missionbox","parserinput","textfield","errormsg","math","struct","cancelbutton","calcbutton","inputdescription","newcalcbutton","introhelptext","emptybox","analysis");this.ui.errormsg.hide();this.specialLoc();this.fixIntro();this.ui.missionbox.hide();this.ui.mission2box.hide();return this},fixIntro:function(){if(this.noroot||this.ui.textfield.val()||"green"===CATS.school.getLessonStatus("realappintro")){return this.ui.introhelptext.hide()}else{return this.ui.introhelptext.show()}},specialLoc:function(){this.ui.textfield.attr("placeholder",CATS.texts.ui.parser.inputplaceholder[CATS.settings.lang]);console.log("LOCSPEC",CATS.settings.lang);this.analyzeMathEntry(this.ui.textfield.val(),true);this.old=this.ui.calcbutton.html();return this},showItem:function(text){this.ui.textfield.val(text);this.analyzeMathEntry(text);this.updateClearBtn();this.fixIntro();this.missionpotential=false;this.mission2potential=false;if(text==="x!=2"){this.missionpotential=true}else if(text==="x+2x"){this.mission2potential=true}return this.updateMission()},updateMission:function(){if(!this.missionpotential||"green"===CATS.school.getLessonStatus("exampleintro")){this.ui.missionbox.hide()}else{this.ui.missionbox.show();if(CATS.school.getMissionStatus("example")){this.ui.missionbox.addClass("togglesecond")}else{this.ui.missionbox.removeClass("togglesecond")}}if(!this.mission2potential||"green"===CATS.school.getLessonStatus("historyintro")){return this.ui.mission2box.hide()}else{this.ui.mission2box.show();if(CATS.school.getMissionStatus("history")){return this.ui.mission2box.addClass("togglesecond")}else{return this.ui.mission2box.removeClass("togglesecond")}}},remoteInput:function(text,source){this.ui.textfield.val(text);console.log("REMOTE INPUT",text,source,this.ui.textfield,this.ui.textfield.val());return this.focusTextField()},setError:function(errorid,errordata){var me;console.log("SETTING ERROR",errorid,this.ui.errormsg);this.ui.errormsg.html(this.getText(["ui","parser","error"+errorid,CATS.settings.lang],true,false,true)+(errordata?" '"+errordata+"'":""));if(this.showingerror){clearTimeout(this.errortimeout)}else{this.showingerror=true;this.ui.errormsg.fadeIn("fast")}me=this;return this.errortimeout=setTimeout(function(){me.showingerror=false;return me.ui.errormsg.fadeOut("fast")},2e3)},inputKeypress:function(e){console.log("KKKKK",e.keyCode,e.charCode);if(e.keyCode===13){return this.enterMath()}else{this.updateClearBtn();return this.analyzeMathEntry(this.ui.textfield.val())}},enterMath:function(e,source){var error,me,o,obj,str;this.missionpotential=false;this.mission2potential=false;this.ui.missionbox.hide();this.ui.calcbutton.blur();this.ui.textfield.blur();this.ui.errormsg.empty();str=this.ui.textfield.val();if(str===""){console.log("WHAT THE EFFF",this.ui.textfield);return this.setError("empty")}else{obj=CATS.app.parseExpression(str,CATS.settings);this.lastentry=str;error=CATS.app.check(obj);if(error){console.log("ERROR",error);return this.setError(error[0],error[1])}else{this.old=this.ui.calcbutton.html();this.ui.calcbutton.css("min-width",this.ui.calcbutton.outerWidth());this.ui.calcbutton.html(this.getLoadingHTML());this.ui.calcbutton.addClass("disabled");o=new CATS.math.Carrier({target:obj});o.simplifiers=CATS.math.simplifiers;me=this;console.log("gonna enter math ok",o);return setTimeout(function(){return me.doMath(o,source,str,true)},150)}}},doMath:function(o,source,str,byuser){var calcerror,e,me,result;try{console.log("gonna try to simplify");result=CATS.math.simplifyAndDecimalify(o,CATS.math);console.log("DID SIMPLDEC",result)}catch(_error){e=_error;this.ui.calcbutton.html(this.old);this.ui.calcbutton.removeClass("disabled");calcerror=e;this.trigger("explosion",{input:str,error:e,why:byuser?"simpl":"example"});throw e}console.log("OK i simplified",result);if(calcerror){this.ui.calcbutton.html(this.old);return this.ui.calcbutton.removeClass("disabled")}else if(result.toshow==="none"){this.ui.calcbutton.html(this.old);this.ui.calcbutton.removeClass("disabled");return this.setError("cannotsimplify")}else{if(byuser){this.setHistory(str)}if(result.toshow==="onlysimpl"){result=result.simpl}if(result.toshow==="onlydec"){result=result.dec}if(result.because==null){result.because=result.who||source}result.inputstring=str;console.log("TOSHOW",result);this.ui.calcbutton.html(this.old);this.ui.calcbutton.removeClass("disabled");me=this;if(result.toshow==="both"){return setTimeout(function(){return me.$el.trigger("showcalcresult",{result:result.simpl,dec:result.dec})},10)}else{return setTimeout(function(){return me.$el.trigger("showcalcresult",{result:result})},10)}}}})}).call(this);