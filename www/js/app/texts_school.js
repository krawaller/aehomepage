(function(){var canLearn,canLearnLesson,checkTool,checkToolSingle,checkTools,count,countDeps,def,doMission,exportTo,forgetLesson,forgetTool,getCurrentDB,getLessonStatus,getMissionStatus,getNbrOpsInLesson,getToolStatus,haslesson,k,learnLesson,learnTool,lessondef,lessonid,lessons,link,linkdef,links,listToolsMissingLesson,loadeddb,m,maybeYellowLightTool,missiontolesson,numberOfAppLessons,numberOfLearnedLessons,numberOfLearnedLessonsPerKind,numberOfLearnedOps,overwriteDB,remainingOpsInLesson,saveDB,signalLesson,toolname,tools,undoMission,v,_i,_j,_len,_len1,_ref,_ref1,_ref2,_ref3;tools=typeof require==="undefined"?CATS.math:require("../code/tools");links=typeof require==="undefined"?CATS.texts.links:require("../build/texts_links");lessons=typeof require==="undefined"?CATS.school.lessons:require("../build/texts_lessons");missiontolesson={};console.log("WHAT THE EFFF heck heck heck",links,lessons);for(lessonid in lessons){def=lessons[lessonid];def.tools=[];console.log("......",lessonid,def.links);_ref=def.links||[];for(_i=0,_len=_ref.length;_i<_len;_i++){link=_ref[_i];linkdef=links[link];if(linkdef.lessons==null){linkdef.lessons=[]}linkdef.lessons.push(lessonid);console.log("added lesson",lessonid,"to word",link)}if(def.missions){_ref1=def.missions;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){m=_ref1[_j];missiontolesson[m]=lessonid}}}haslesson=0;for(toolname in tools){def=tools[toolname];if(!(def.info&&def.info.lesson)){continue}haslesson++;if(!lessons[def.info.lesson]){throw"Unknown lesson!! Op "+toolname+", lesson "+def.info.lesson}lessons[def.info.lesson].tools=(lessons[def.info.lesson].tools||[]).concat(toolname)}loadeddb=null;getCurrentDB=function(){var currentname;if(!loadeddb){currentname=CATS.settings.currentpupil||"AEDEFAULT";loadeddb=JSON.parse(localStorage.getItem("ALGEBRAEPLORERPUPIL_"+currentname)||JSON.stringify({}));if(!loadeddb.format){loadeddb={format:1,lessons:{},tools:loadeddb,missions:{}}}}return loadeddb};overwriteDB=function(db){var currentname;currentname=CATS.settings.currentpupil||"AEDEFAULT";localStorage.setItem("ALGEBRAEPLORERPUPIL_"+currentname,JSON.stringify(db));return loadeddb=db};saveDB=function(){var currentname,db;currentname=CATS.settings.currentpupil||"AEDEFAULT";db=getCurrentDB();return localStorage.setItem("ALGEBRAEPLORERPUPIL_"+currentname,JSON.stringify(db))};signalLesson=function(lessonid){console.log("LESSONSIGNAL",lessonid);return Backbone.trigger("updatelesson",lessonid)};learnTool=function(toolname){var db,dep,_k,_len2,_ref2,_results;db=getCurrentDB().tools;if(db[toolname]!==2){db[toolname]=2;saveDB();Backbone.trigger("learnedtool",toolname);if(tools[toolname].info.lesson){signalLesson(tools[toolname].info.lesson)}_ref2=tools[toolname].info.usedby||[];_results=[];for(_k=0,_len2=_ref2.length;_k<_len2;_k++){dep=_ref2[_k];_results.push(maybeYellowLightTool(dep))}return _results}};forgetTool=function(toolname,mem){var can,db,dbtools,dep,_k,_len2,_ref2,_results;if(!mem){mem={};mem[toolname]=true}db=getCurrentDB();dbtools=db.tools;if(dbtools[toolname]){can=canLearn(toolname);if(tools[toolname].info.uses&&can){dbtools[toolname]=1}else{delete dbtools[toolname]}Backbone.trigger(can?"forgottool":"losttouchoftool",toolname);lessonid=tools[toolname].info.lesson;if(lessonid){delete db.lessons[lessonid];signalLesson(lessonid)}saveDB();_ref2=tools[toolname].info.usedby||[];_results=[];for(_k=0,_len2=_ref2.length;_k<_len2;_k++){dep=_ref2[_k];if(!(dbtools[dep]&&!mem[dep]&&(tools[dep].info.circle||[]).indexOf(toolname)===-1)){continue}mem[dep]=true;_results.push(forgetTool(dep,mem))}return _results}};countDeps=function(toolname,mem){var count,db,dep,_k,_len2,_ref2;if(!mem){mem={};mem[toolname]=true}db=getCurrentDB().tools;count=0;_ref2=tools[toolname].info.usedby||[];for(_k=0,_len2=_ref2.length;_k<_len2;_k++){dep=_ref2[_k];if(!(db[dep]===2&&!mem[dep]&&(tools[dep].info.circle||[]).indexOf(toolname)===-1)){continue}mem[dep]=true;count+=1+countDeps(dep,mem)}return count};maybeYellowLightTool=function(toolname){var db,dep,tinfo,_k,_len2,_ref2;db=getCurrentDB().tools;tinfo=tools[toolname].info;if(db[toolname]===2||!tinfo.uses){return}console.log("Maybe yellowlight",toolname);_ref2=tinfo.uses;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){dep=_ref2[_k];if(!(tinfo.circle&&tinfo.circle.indexOf(dep)!==-1)){if(db[dep]!==2){console.log("Nope, because",dep,db[dep]);return false}}}db[toolname]=1;saveDB();Backbone.trigger("qualifiedtool",toolname);if(tools[toolname].info.lesson){return signalLesson(tools[toolname].info.lesson)}};canLearn=function(toolname){var db,dep,tinfo,_k,_len2,_ref2;db=getCurrentDB().tools;tinfo=tools[toolname].info;_ref2=tinfo.uses||[];for(_k=0,_len2=_ref2.length;_k<_len2;_k++){dep=_ref2[_k];if(dep!==toolname&&db[dep]!==2&&!(tinfo.circle&&tinfo.circle.indexOf(dep)!==-1)){return false}}return true};getToolStatus=function(toolname){var db,_ref2;db=getCurrentDB().tools;if(!((_ref2=tools[toolname])!=null?_ref2.info:void 0)){return"green";throw"SCHOOL strange tool "+toolname}if(db[toolname]){return["FOOBAR","yellow","green"][db[toolname]]}else if((tools[toolname].info.uses||[]).length===0){return"yellow"}else{return"red"}};canLearnLesson=function(lessonid){var db,_k,_len2,_ref2;db=getCurrentDB().tools;_ref2=lessons[lessonid];for(_k=0,_len2=_ref2.length;_k<_len2;_k++){toolname=_ref2[_k];if(db[toolname]!==2){return false}}return true};remainingOpsInLesson=function(lessonid){var count,db,_k,_len2,_ref2;db=getCurrentDB().tools;count=0;_ref2=lessons[lessonid].tools;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){toolname=_ref2[_k];if(db[toolname]!==2){count++}}return count};getNbrOpsInLesson=function(lessonid){return lessons[lessonid].tools.length};getLessonStatus=function(lessonid){var db,missionname,_k,_l,_len2,_len3,_ref2,_ref3,_ref4;if(lessonid==="STATUSUPDATE"){return"red"}db=getCurrentDB();if(db.lessons[lessonid]){return"green"}else{if(!lessons[lessonid]){throw"Status query for unknown lesson: "+lessonid}_ref2=lessons[lessonid].tools;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){toolname=_ref2[_k];if(db.tools[toolname]!==2){return"red"}}_ref3=lessons[lessonid].missions||[];for(_l=0,_len3=_ref3.length;_l<_len3;_l++){missionname=_ref3[_l];if(!((_ref4=db.missions)!=null?_ref4[missionname]:void 0)){return"red"}}return"yellow"}};learnLesson=function(lessonid){var db;db=getCurrentDB();db.lessons[lessonid]=true;signalLesson(lessonid);return saveDB()};forgetLesson=function(lessonid){var db;db=getCurrentDB();delete db.lessons[lessonid];signalLesson(lessonid);return saveDB()};numberOfLearnedOps=function(){var db,n,tooldef,toolid;db=getCurrentDB().tools;n=0;for(toolid in tools){tooldef=tools[toolid];if(db[toolid]===2&&tools[toolid]){n++}}return n};count=1;for(lessonid in lessons){lessondef=lessons[lessonid];lessondef.order=count++}checkTool=function(toolname,maxlesson,mem){var childtoolname,faults,tool,_k,_len2,_ref2,_ref3;if(mem==null){mem={}}mem[toolname]=true;tool=tools[toolname];if(maxlesson==null){maxlesson=tool.info.lesson}if(lessons[tool.info.lesson].order>lessons[maxlesson].order){return[toolname]}else{faults=[];_ref2=tool.info.uses||[];for(_k=0,_len2=_ref2.length;_k<_len2;_k++){childtoolname=_ref2[_k];if(!mem[childtoolname]&&((_ref3=tools[childtoolname].info)!=null?_ref3.lesson:void 0)&&(tool.info.circle||[]).indexOf(childtoolname)===-1){faults=faults.concat(checkTool(childtoolname,maxlesson,mem))}}return faults}};checkToolSingle=function(toolname){var childtoolname,max,ret,tool,_k,_len2,_ref2,_ref3,_ref4,_ref5;tool=tools[toolname];max=((_ref2=lessons[tool.info.lesson])!=null?_ref2.order:void 0)||0;ret=[];_ref3=tool.info.uses||[];for(_k=0,_len2=_ref3.length;_k<_len2;_k++){childtoolname=_ref3[_k];if(((_ref4=tools[childtoolname].info)!=null?_ref4.lesson:void 0)&&(tool.info.circle||[]).indexOf(childtoolname)===-1){if(((_ref5=lessons[tools[childtoolname].info.lesson])!=null?_ref5.order:void 0)>max){ret.push(childtoolname)}}}return ret};checkTools=function(){var n,res,tooldef,_ref2,_results;console.log("CHECKING TOOL LESSONS");_results=[];for(toolname in tools){tooldef=tools[toolname];if(!((_ref2=tooldef.info)!=null?_ref2.lesson:void 0)){continue}res=checkToolSingle(toolname);if(res.length){res=function(){var _k,_len2,_results1;_results1=[];for(_k=0,_len2=res.length;_k<_len2;_k++){n=res[_k];_results1.push(n+"("+tools[n].info.lesson+")")}return _results1}();_results.push(console.log("Error for tool",toolname,tooldef.info.lesson,res))}else{_results.push(void 0)}}return _results};listToolsMissingLesson=function(){var tooldef,_results;_results=[];for(toolname in tools){tooldef=tools[toolname];if(tooldef.info&&!tooldef.info.lesson){_results.push(console.log("No lesson for",toolname))}}return _results};doMission=function(name){var db;db=getCurrentDB();if(db.missions==null){db.missions={}}db.missions[name]=true;saveDB();console.log("Doing mission",name);Backbone.trigger("updatemission",name);return Backbone.trigger("updatelesson",missiontolesson[name])};undoMission=function(name){var db;db=getCurrentDB();if(db.missions==null){db.missions={}}delete db.missions[name];saveDB();console.log("Undoing mission",name);Backbone.trigger("updatemission",name);return Backbone.trigger("updatelesson",missiontolesson[name])};getMissionStatus=function(name){var db,_ref2;db=getCurrentDB();return(_ref2=db.missions)!=null?_ref2[name]:void 0};numberOfLearnedLessons=function(){var db,n;db=getCurrentDB();n=0;for(lessonid in lessons){if(db.lessons[lessonid]){n++}}return n};numberOfAppLessons=14;if(typeof CATS!=="undefined"&&CATS!==null?(_ref2=CATS.settings)!=null?_ref2.krim:void 0:void 0){numberOfAppLessons--}numberOfLearnedLessonsPerKind=function(){var appl,db,mathl,total;db=getCurrentDB();appl=0;mathl=0;total=0;for(lessonid in lessons){lessondef=lessons[lessonid];total++;if(db.lessons[lessonid]){if(lessondef.number<=numberOfAppLessons){appl++}else{mathl++}}}return{applessonslearned:appl,applessonstotal:numberOfAppLessons,mathlessonslearned:mathl,mathlessonstotal:total-numberOfAppLessons}};if(typeof exports==="undefined"){exportTo=this.CATS.school}else{exportTo=exports}_ref3={overwriteDB:overwriteDB,numberOfLearnedLessonsPerKind:numberOfLearnedLessonsPerKind,numberOfAppLessons:numberOfAppLessons,doMission:doMission,undoMission:undoMission,getMissionStatus:getMissionStatus,numberOfLearnedOps:numberOfLearnedOps,numberOfLearnedLessons:numberOfLearnedLessons,getNbrOpsInLesson:getNbrOpsInLesson,listToolsMissingLesson:listToolsMissingLesson,checkTools:checkTools,canLearn:canLearn,maybeYellowLightTool:maybeYellowLightTool,signalLesson:signalLesson,remainingOpsInLesson:remainingOpsInLesson,countDeps:countDeps,lessons:lessons,getToolStatus:getToolStatus,learnTool:learnTool,forgetTool:forgetTool,getCurrentDB:getCurrentDB,getLessonStatus:getLessonStatus,learnLesson:learnLesson,forgetLesson:forgetLesson,haslesson:haslesson};for(k in _ref3){v=_ref3[k];exportTo[k]=v}}).call(this);