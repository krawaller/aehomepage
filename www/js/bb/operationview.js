(function(){CATS.bb.OperationView=CATS.bb.BaseView.extend({tagName:"div",className:"operation",localizeid:"operation",spec:"almes",initialize:function(o,rownum,sequencepath,belowbtn,parenttool,prevstepnums,rownumspecial){this.o=o;this.rownum=rownum;this.sequencepath=sequencepath!=null?sequencepath:[];this.belowbtn=belowbtn;this.parenttool=parenttool;this.prevstepnums=prevstepnums!=null?prevstepnums:[];this.rownumspecial=rownumspecial;return this.constructor.__super__.initialize.apply(this,[o])},events:{"click .buttonstepsbelow":"zoom","click .toggler":"toggleDetails"},toggleDetails:function(e){this.$el.toggleClass("collapsed");return this.ui.toggler.toggleClass("active")},zoom:function(e){var button,me,oldhtml,_ref;button=$(e.currentTarget);if(!button.hasClass("disabled")){console.log("Operationview zoom top! "+this.substeps.descriptor);if(!!CATS[this.spec.slice(1,3)]&&((_ref=this.prevstepnums)!=null?_ref.length:void 0)){return window[this.spec[0]+"l"+this.spec[3]+"rt"](CATS.texts.ui[this.spec[3]+"xamples"]["b"+this.spec[0]+"ckbtn"][CATS.settings.lang])}else if(this.substeps.rendered){console.log("Operationview stepbutton clicked for rendered view! "+this.substeps.descriptor);return this.trigger("zoom",this.substeps,this.sequencepath)}else{console.log("Operationview stepbutton clicked! "+this.substeps.descriptor);button.css("min-width",button.outerWidth());oldhtml=button.html();button.html(this.getLoadingHTML(CATS.settings.lang));button.addClass("disabled");me=this;return setTimeout(function(){return me.substeps.getready(_.bind(function(){console.log("Operationview zoom callback triggered! "+this.substeps.descriptor);button.html(oldhtml);button.removeClass("disabled");return me.trigger("zoom",me.substeps,me.sequencepath)},me))},50)}}},back:function(){return this.trigger("sequenceback")},passOnZoom:function(view,path){return this.trigger("zoom",view,path)},passOnNewSequenceContainer:function(view){return this.trigger("newsequenceview",view)},sequenceTop:function(){return this.trigger("sequencetop")},kill:function(){var _ref,_ref1;if((_ref=this.before)!=null){_ref.kill()}if((_ref1=this.after)!=null){_ref1.kill()}if(this.substeps){this.substeps.kill()}return this.cleanup()},specialString:function(){var lang,path,_ref,_ref1,_ref2;lang=CATS.settings.lang;path=(_ref=this.o.because)==="toolexample"||_ref==="userinputsingle"||_ref==="userinputsingleatomic"||_ref==="inputexamplesingle"||this.o.because==="simplifying"&&((_ref1=this.parenttool)==="simplifier"||_ref1==="decimalifier")?[this.o.who,lang,"explanation"]:[this.parenttool,lang,"steps",this.o.because];if(this.o.who!=="demonstration"){this.setText(".becausecontainer",["tools"].concat(path),false,false,true)}else{this.setText(".becausecontainer",["tools","demonstration",lang,"steps",this.o.demonstrationname+"_OPINTRO"],false,false,true)}if(!((_ref2=this.o.who)==="simplifier"||_ref2==="decimalifier"||_ref2==="demonstration")){this.ui.toolnamecontainer.html(this.toolLink(this.o.who));if(false){this.ui.opsubsintro.setText(this.o.steps?"stepintrocomplexop":"stepintrobasicop");this.ui.opsubsintro.html(this.ui.opsubsintro.html().replace("%STEPS",CATS.texts.numberStr(this.o.steps.length,lang)))}}else{this.ui.toolnamecontainer.hide();this.ui.becausecontainer.parent().addClass("centered")}if(this.belowbtn){return this.setText(this.ui.buttonstepsbelow,["ui","mastersequence",this.belowbtn,lang],true,false,true)}else if(this.o.steps){this.setText(this.ui.buttonstepsbelow,["ui","operation","buttonsteps"+Math.min(3,this.o.steps.length),lang],true,false,true);this.ui.buttonstepsbelow.html(this.ui.buttonstepsbelow.html().replace("%NAME","<span class='inlinerownum'>"+this.ui.rownum.text()+"</span>"));return this.ui.buttonstepsbelow.html(this.ui.buttonstepsbelow.html().replace("%NUM",CATS.texts.numberStr(this.o.steps.length,lang)))}},fixReportLink:function(){return this.ui.reportlink.attr("linkto","calc|"+JSON.stringify({performer:this.o.parent,tool:this.o.who,because:this.o.because,before:this.o.before,after:this.o.after,addr:this.o.addr,input:this.o.input}))},updateMission:function(){console.log("operationview updatemission running....");if("green"===CATS.school.getLessonStatus("substepsintro")||this.prevstepnums.concat(this.rownum).join(",")!=="1,2,1,1,3"){this.ui.substepmissionbox.hide();console.log("operationview no mission",this.o.who,this.prevstepnums.concat(this.rownum).join(","))}else{this.ui.substepmissionbox.show();console.log("operationview is substepmission!");if(CATS.school.getMissionStatus("substep12113")){this.ui.substepmissionbox.addClass("togglesecond")}else{this.ui.substepmissionbox.removeClass("togglesecond")}}if(this.rownum!==2||this.prevstepnums.length||this.sequencepath.length||"green"===CATS.school.getLessonStatus("resultdetails")||this.o.who!=="oneDenomFracToNumer"||!CATS.math.equal(this.o.after,{type:"variable",val:"x"})){this.ui.detailmissionbox.hide();return console.log("operationview no detail mission",this.sequencepath,this.o.who,CATS.math.equal(this.o.after,{type:"variable",val:"x"}))}else{this.ui.detailmissionbox.show();console.log("operationview is detail mission");if(CATS.school.getMissionStatus("stepdetails")){return this.ui.detailmissionbox.addClass("togglesecond")}else{return this.ui.detailmissionbox.removeClass("togglesecond")}}},render:function(startcollapsed){var afterobj,lang,prepath,prepathcalc,_ref,_ref1,_ref2,_ref3,_ref4;lang=CATS.settings.lang;this.$el.html(CATS.cache.templates["#operationviewtemplate"]);this.setUI("detailmissionbox","substepmissionbox","buttonstepsbelow","beforecontainer","aftercontainer","afternomarkcontainer","becausecontainer","toolnamecontainer","rownum","reportbox","reportlink","opsubsintro","oprest","optop","toggler");prepathcalc=function(digpast,path){var i,pathpart,ret,_i,_len;ret=[];for(i=_i=0,_len=path.length;_i<_len;i=++_i){pathpart=path[i];if(i>=digpast.length){ret.push(pathpart)}}return ret};if(this.rownum){prepath=prepathcalc(this.sequencepath,this.o.path||[]);this.before=new CATS.bb.jaxview(CATS.math.lookUp(this.o.before,this.sequencepath),(_ref=this.o.who)==="simplifier"||_ref==="decimalifier"?[999]:prepath,this.o.beforemarks||[],true,(_ref1=this.o.who)==="simplifier"||_ref1==="decimalifier");afterobj=CATS.math.lookUp(this.o.after,this.sequencepath);this.after=new CATS.bb.jaxview(afterobj,(_ref2=this.o.who)==="simplifier"||_ref2==="decimalifier"?[999]:prepath,this.o.aftermarks||[],true,(_ref3=this.o.who)==="simplifier"||_ref3==="decimalifier");this.ui.afternomarkcontainer.html(CATS.app.mathmlprinter(afterobj,[],[],true,CATS.settings,true));this.ui.beforecontainer.append(this.before.render().el);this.ui.aftercontainer.append(this.after.render().el)}else{this.ui.oprest.hide();if((_ref4=this.prevstepnums)!=null?_ref4.length:void 0){this.ui.optop.hide();this.ui.toolnamecontainer.hide()}}if(this.rownum){if(this.rownumspecial){this.setText(this.ui.rownum,["ui","mastersequence",this.rownumspecial,lang],false,false,true)}else{if(startcollapsed&&this.prevstepnums.length&&this.rownum){this.ui.rownum.html("<span>"+this.prevstepnums.join(".")+".</span>"+this.rownum)}else{this.ui.rownum.text(this.prevstepnums.concat(this.rownum||[]).join("."))}}}else{this.ui.rownum.hide()}if(this.belowbtn){console.log("BELOWBUTTON: "+this.belowbtn);this.ui.buttonstepsbelow.removeClass("buttonstepsbelow").addClass(this.belowbtn)}else if(this.rownum&&this.o.steps){this.substeps=new CATS.bb.SequenceView(this.o,this.o.path,this.o.who,this.parenttool,this.sequencepath,this.prevstepnums.concat(this.rownum));this.substeps.$el.addClass("sequencehiddenright "+this.prevstepnums.concat(this.rownum).join("-"));this.listenTo(this.substeps,"sequenceback",this.back);this.listenTo(this.substeps,"sequencetop",this.sequenceTop);this.listenTo(this.substeps,"zoom",this.passOnZoom);this.listenTo(this.substeps,"newsequenceview",this.passOnNewSequenceContainer);this.trigger("newsequenceview",this.substeps)}else{this.ui.buttonstepsbelow.hide()}this.specialString();if(startcollapsed){this.$el.addClass("collapsed")}this.toolLinkAware();this.fixReportLink();if(this.prevstepnums.concat(this.rownum).join(",")==="1,2,1,1,3"||this.rownum===2&&this.o.who==="oneDenomFracToNumer"){this.listenTo(Backbone,"updatemission",this.updateMission);this.listenTo(Backbone,"updatelesson",this.updateMission);this.updateMission()}else{this.ui.substepmissionbox.hide();this.ui.detailmissionbox.hide()}return this}})}).call(this);